<!DOCTYPE html>
<html>
  <head>
    <script src='../node_modules/d3/build/d3.js'></script>
    <script src='../node_modules/d3-selection-multi/build/d3-selection-multi.js'></script>
    <script src='../build/d3-flextree.js'></script>
  </head>
  <body>
    <h1>d3-flextree image</h1>
    <div id='content'></div>
    <script>
      const opts = {
        vertical: true,
        numNodes: 20,
        xSizeMin: 20,
        xSizeMax: 70,
        ySizeMin: 30,
        ySizeMax: 80,
        svg: {
          width: 400,
          height: 300,
        },
        box: {
          padding: {
            x: 2,
            y: 10,
          },
        }
      };
      const {vertical, numNodes, xSizeMin, xSizeMax, ySizeMin, ySizeMax} = opts;

      const randomInt = max => Math.floor(Math.random() * max);
      const randomSize = (min, max) => () => randomInt(max - min) + min;
      const randomXSize = randomSize(xSizeMin, xSizeMax);
      const randomYSize = randomSize(ySizeMin, ySizeMax);
      const randomItemFrom = arr => arr[randomInt(arr.length)];
      const randomHue = () => randomInt(360);
      const randomNode = id => ({
        id,
        size: [randomXSize(), randomYSize()],
        children: [],
        hue: randomHue(),
      });

      const dataNodes = [...Array(numNodes)].reduce((acc, id) => {
        const dataNode = randomNode(id);
        if (acc.length > 0) {
          const parent = randomItemFrom(acc);
          parent.children.push(dataNode);
        }
        return acc.concat(dataNode);
      }, []);

      const treeData = dataNodes[0];

      const flextree = d3.flextree;
      const layout = flextree();
      const tree = layout.hierarchy(treeData);
      layout(tree);

      const svg = d3.select('#content').append('svg').attrs({
        width: opts.svg.width,
        height: opts.svg.height,
      });
      const svgG = svg.append('g').attrs({
        transform: `translate(0, 0)`,
      });

      const nodes = tree.nodes;
      const boxXSize = node => node.data.size[0] - 2*opts.box.padding.x;
      const boxYSize = node => node.data.size[1] - opts.box.padding.y;

      const nodeSel = svgG.selectAll('g.node').data(nodes, d => d.id);
      const nodeEnter = nodeSel.enter().append('g').attrs({
        'class': 'node',
        transform: node => `translate(${node.x}, ${node.y})`,
      });
      nodeEnter.append('rect').attrs({
        'class': 'node',
        x: node => -node.data.size[0]/2,
        y: 0,
        width: node => node.data.size[0],
        height: node => node.data.size[1],
        rx: 5, ry: 5,
        fill: 'none',
        stroke: 'hsla(0, 100%, 0%, 0.2)',
        'stroke-width': 1,
        'stroke-dasharray': 5,
      });
      nodeEnter.append('rect').attrs({
        x: node => -boxXSize(node)/2 ,
        y: 0,
        width: boxXSize,
        height: boxYSize,
        fill: node => `hsl(${node.data.hue}, 100%, 70%)`,
        rx: 5, ry: 5,
      });

      const links = tree.links();
      const linkSel = svgG.selectAll('path.link')
        .data(links, link => link.target.id);
      const linkEnter = linkSel.enter();

      const linkPath = d3.linkVertical();
      linkPath.source(link => {
        const srcNode = link.source;
        return [srcNode.x, srcNode.y + boxYSize(srcNode)];
      });
      linkPath.target(link => {
        const trgNode = link.target;
        return [trgNode.x, trgNode.y];
      });
      linkEnter.append('path').attrs({
        'class': 'link',
        d: linkPath,
        fill: 'none',
        stroke: '#BBB',
        'stroke-width': 1,
      });

      const extents = tree.extents;
      svg.attrs({
        width: extents.right - extents.left,
        height: extents.bottom - extents.top,
      });
      svgG.attrs({
        transform: `translate(${-extents.left}, 0)`,
      })


    </script>
  </body>
</html>
